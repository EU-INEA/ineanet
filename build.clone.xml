<?xml version="1.0" encoding="UTF-8" ?>

<project name="My subsite" default="help">

    <!-- Download production database. -->
    <target name="dbprod" description="Download production database.">
        <phingcall target="download-prod-db" />
        <phingcall target="import-prod-db" />
    </target>

    <!-- Import production database. -->
    <target name="import-prod-db" description="Import production database." depends="download-prod-db">
        <echo msg="Import production database." />
        <!-- Drop database, create if necessary and import the dump. -->
        <exec command="echo y | mysqladmin -u${drupal.db.user} -p${drupal.db.password} drop ${drupal.db.name}" logoutput="true" />
        <exec command="mysqladmin -u${drupal.db.user} -p${drupal.db.password} create ${drupal.db.name}" logoutput="true" />
        <exec command="mysql -u${drupal.db.user} -p${drupal.db.password} ${drupal.db.name} &lt; tmp/${gunzipped.filename}" checkreturn="false" passthru="false" logoutput="true" />
        <!-- Rebuild Registry. -->
        <drush command="registry-rebuild" assume="yes" root="${platform.build.dir}" bin="${drush.bin}" verbose="${drush.verbose}">
            <param>--fire-bazooka</param>
        </drush>
        <!-- Update database. -->
        <drush command="updatedb" assume="yes" root="${platform.build.dir}" bin="${drush.bin}"></drush>
        <!-- Clear Caches. -->
        <drush command="cc" assume="yes" root="${platform.build.dir}" bin="${drush.bin}" verbose="${drush.verbose}">
            <param>all</param>
        </drush>
    </target>

    <!-- Download the production database. -->
    <target name="download-prod-db" description="Download the production database." >
        <echo msg="Download the production database." />
        <!--Strips gz suffix-->
        <php expression="substr('${project.database.filename}', 0, -3)" returnProperty="gunzipped.filename"/>
        <echo msg="${gunzipped.filename}" />
        <if>
            <not>
                <available file="tmp/${gunzipped.filename}" type="file" property="gunzipped.project.db" />
            </not>
            <then>
                <exec command="wget ${project.database.url}${project.database.filename}" dir="tmp" checkreturn="false" passthru="false" logoutput="true" />
                <exec command="gunzip tmp/${project.database.filename}" checkreturn="false" passthru="false" logoutput="true" />
            </then>
            <else>
                <echo msg="File already downloaded." />
            </else>
        </if>
    </target>

    <!-- Regenerate the settings file with database credentials and development variables. -->
    <target name="regenerate-settings" description="Regenerate settings.php file.">
        <copy file="src/Drupal/generate-settings.php" tofile="tmp/generate-settings.php" overwrite="true">
            <filterchain>
                <replacetokens begintoken="%%" endtoken="%%">
                    <!-- Replace tokens in settings generation script. -->
                    <token key="drupal.db.type" value="${drupal.db.type}" />
                    <token key="drupal.db.name" value="${drupal.db.name}" />
                    <token key="drupal.db.user" value="${drupal.db.user}" />
                    <token key="drupal.db.password" value="${drupal.db.password}" />
                    <token key="drupal.db.host" value="${drupal.db.host}" />
                    <token key="drupal.db.port" value="${drupal.db.port}" />
                    <token key="development.variables.error_level" value="${development.variables.error_level}" />
                    <token key="development.variables.views_ui_show_sql_query" value="${development.variables.views_ui_show_sql_query}" />
                    <token key="development.variables.views_ui_show_performance_statistics" value="${development.variables.views_ui_show_performance_statistics}" />
                    <token key="development.variables.views_show_additional_queries" value="${development.variables.views_show_additional_queries}" />
                    <token key="development.variables.stage_file_proxy_origin" value="${development.variables.stage_file_proxy_origin}" />
                    <token key="development.variables.stage_file_proxy_origin_dir" value="${development.variables.stage_file_proxy_origin_dir}" />
                    <token key="development.variables.stage_file_proxy_hotlink" value="${development.variables.stage_file_proxy_hotlink}" />
                    <token key="development.variables.theme_default" value="${development.variables.theme_default}" />
                </replacetokens>
            </filterchain>
        </copy>
        <!-- Execute setttings generation script. -->
        <drush command="php-script" root="${platform.build.dir}" bin="${drush.bin}" verbose="${drush.verbose}">
            <param>tmp/generate-settings.php</param>
        </drush>
    </target>

    <!-- Install a development version of the subsite with a production database. -->
    <target name="build-clone" description="Setup a clone of production." depends="regenerate-settings, dbprod, enable-development-modules" />

</project>
